/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var j=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var _=Object.getOwnPropertyNames;var ee=Object.prototype.hasOwnProperty;var te=(l,e)=>{for(var t in e)j(l,t,{get:e[t],enumerable:!0})},ne=(l,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of _(e))!ee.call(l,a)&&a!==t&&j(l,a,{get:()=>e[a],enumerable:!(n=Z(e,a))||n.enumerable});return l};var se=l=>ne(j({},"__esModule",{value:!0}),l);var ie={};te(ie,{default:()=>$});module.exports=se(ie);var Q=require("obsidian");var ae={mySetting:"default",sortDescending:!0,blocksCollapsed:!0,showInDailyNotes:!1,blockBoundaryStrategy:"default",theme:"default",showFullPathTitle:!1};var x=class{constructor(e){this.plugin=e}async loadSettings(){this.settings=Object.assign({},ae,await this.plugin.loadData())}async saveSettings(){await this.plugin.saveData(this.settings)}};var K=require("obsidian");var J=require("obsidian");var G=require("obsidian");var v=class{static enable(){v.enabled=!0}static disable(){v.enabled=!1}info(e,...t){v.enabled&&console.log(e,...t)}warn(e,...t){v.enabled&&console.warn(e,...t)}debug(e,...t){v.enabled&&console.debug(e,...t)}},h=v;h.enabled=!1;var P=class{constructor(e,t,n,a){this.contents=e;this.filePath=t;this.noteName=n;this.showFullPathTitle=a;this.logger=new h}async render(e,t,n){let a=this.filePath.replace(/\.md$/,"");this.mainContainer=e.createDiv({cls:"backlink-item"}),this.headerContainer=this.mainContainer.createDiv({cls:"block-header"}),this.toggleButton=this.headerContainer.createEl("span",{cls:"toggle-arrow",text:"\u25BC"}),this.headerContainer.createEl("a",{text:this.getDisplayTitle(this.filePath,this.showFullPathTitle),cls:"block-title",href:"#"}).addEventListener("click",i=>{i.preventDefault(),n(this.filePath)});let s=this.mainContainer.createDiv("content-preview");await G.MarkdownRenderer.render(t.app,this.contents,s,this.filePath,t),s.querySelectorAll("a.internal-link").forEach(i=>{i.addEventListener("click",r=>{this.logger.info("Link clicked!"),r.preventDefault();let p=i.getAttribute("href");if(p){let m=decodeURI(p),V=m.endsWith(".canvas")||m.endsWith(".md")?m:`${m}.md`;n(V)}})}),s.style.display="block",this.toggleButton.addEventListener("click",()=>{let i=s.style.display==="none";s.style.display=i?"block":"none",this.toggleButton.textContent=i?"\u25BC":"\u25B6"})}getContainer(){return this.mainContainer}setArrowState(e){this.toggleButton&&(this.toggleButton.textContent=e?"\u25BC":"\u25B6")}getDisplayTitle(e,t){if(t)return e.replace(/\.md$/,"");{let n=e.split("/");return n[n.length-1].replace(/\.md$/,"")}}updateTitleDisplay(e){var n;let t=(n=this.headerContainer)==null?void 0:n.querySelector(".block-title");t&&(t.textContent=this.getDisplayTitle(this.filePath,e))}getFileName(e){var t;return((t=e.split("/").pop())==null?void 0:t.replace(".md",""))||e}};var D=class{createHeader(e,t,n,a,o,s,i,r,p,m,V,X,Y){let T=document.createElement("div");T.classList.add("backlinks-header");let d=document.createElement("div");d.classList.add("backlinks-header-left");let I=document.createElement("div");I.classList.add("backlinks-header-right");let k=document.createElementNS("http://www.w3.org/2000/svg","svg");k.setAttribute("viewBox","0 0 100 100"),k.setAttribute("width","18"),k.setAttribute("height","18"),k.setAttribute("fill","currentColor"),k.innerHTML='<path d="M85 40.5C85 22.5 70.5 10 52.5 10c-27.6 0-43.1 24.5-43.1 40 0 21.7 16.8 40 42.6 40 11.3 0 21.1-2.8 27.4-6.5 2.2-1.3 3.6-2.8 3.6-4.4 0-1.3-0.9-2.4-2.2-2.4-0.6 0-1.2 0.2-2 0.7-6.8 4.8-15.9 7.1-26.8 7.1-22.3 0-36.2-15.4-36.2-34.5 0-19.1 13.9-34.5 36.2-34.5 15.4 0 27.5 10.3 27.5 24.5 0 11.8-7.8 19.5-16.8 19.5-4.9 0-7.8-2.5-7.8-6.7 0-1.1 0.2-2.3 0.5-3.4l4.1-16.8c0.9-3.7-1.1-5.6-4-5.6-4.9 0-9.6 5-9.6 12.3 0 5.6 3.1 9.5 9.3 9.5 4.7 0 9.1-1.9 12.4-5.4 3.3 3.5 8.2 5.4 14.3 5.4C73.2 60 85 51.5 85 40.5z"/>',d.appendChild(k);let L=document.createElement("span");L.classList.add("header-title"),L.textContent=`${t} ${t===1?"Backlink":"Backlinks"}, ${n} ${n===1?"Block":"Blocks"}`,d.appendChild(L);let B=document.createElement("button");B.classList.add("clickable-icon","sort-button"),B.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 16 16" style="transform: ${a?"none":"rotate(180deg)"}">
                <path fill="currentColor" d="M4 4l4 4 4-4H4z"/>
            </svg>
        `,B.addEventListener("click",o),d.appendChild(B);let M=document.createElement("button");M.classList.add("clickable-icon","collapse-button"),M.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 16 16" style="transform: ${i?"rotate(-90deg)":"none"}">
                <path fill="currentColor" d="M4 4l4 4 4-4H4z"/>
            </svg>
        `,M.addEventListener("click",s),d.appendChild(M);let b=document.createElement("select");b.classList.add("strategy-select"),["default","single-line"].forEach(u=>{let c=document.createElement("option");c.value=u,c.textContent=u.replace("-"," ").toUpperCase(),c.selected=u===r,b.appendChild(c)}),b.addEventListener("change",()=>{p(b.value)}),d.appendChild(b);let y=document.createElement("select");y.classList.add("theme-select"),["default","minimal","modern"].forEach(u=>{let c=document.createElement("option");c.value=u,c.textContent=u.charAt(0).toUpperCase()+u.slice(1),c.selected=u===m,y.appendChild(c)}),y.addEventListener("change",()=>{V(y.value)}),d.appendChild(y);let w=document.createElement("button");w.className="settings-button",w.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
            </svg>
        `;let g=null,S=X;return w.addEventListener("click",u=>{if(u.stopPropagation(),g){g.remove(),g=null;return}g=document.createElement("div"),g.className="settings-popup";let c=document.createElement("div");c.className="settings-item";let O=document.createElement("div");O.className="setting-item-icon",O.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3h18v18H3z"></path>
                    <path d="M3 9h18"></path>
                </svg>
            `;let q=document.createElement("span");q.textContent="Full path note title",q.className="setting-item-label";let R=document.createElement("div");R.className="checkmark-container";let E=document.createElement("div");E.className="checkmark",E.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
            `,E.style.display=S?"block":"none",R.appendChild(E),c.appendChild(O),c.appendChild(q),c.appendChild(R),g.appendChild(c),c.addEventListener("click",()=>{S=!S,E.style.display=S?"block":"none",Y(S)});let U=w.getBoundingClientRect();g.style.top=`${U.bottom+5}px`,g.style.left=`${U.left}px`,document.body.appendChild(g);let z=W=>{g&&!g.contains(W.target)&&W.target!==w&&(g.remove(),g=null,document.removeEventListener("click",z))};document.addEventListener("click",z)}),d.appendChild(k),d.appendChild(L),d.appendChild(B),d.appendChild(M),d.appendChild(b),d.appendChild(y),I.appendChild(w),T.appendChild(d),T.appendChild(I),T}};var f=class{findBlockBoundaries(e,t){let n=[],a=new RegExp(`\\[\\[${t}\\]\\]`,"g"),o;for(;(o=a.exec(e))!==null;){let s=e.lastIndexOf(`
`,o.index)+1,i=e.indexOf("---",o.index),r=e.indexOf(`[[${t}]]`,o.index+1),p=e.length;i!==-1&&(r===-1||i<r)?p=i:r!==-1&&(p=r),n.push({start:s,end:p})}return n}};var C=class{findBlockBoundaries(e,t){let n=[],a=e.split(`
`);if(a.length>0){let o=a[0];n.push({start:0,end:o.length})}return n}};var N=class{constructor(e,t,n,a){this.view=e;this.settingsManager=n;this.logger=new h;this.headerComponent=new D;this.allBlocks=[];this.currentNoteName=t,this.blockBoundaryStrategy=a,this.sortDescending=this.settingsManager.settings.sortDescending,this.blocksCollapsed=this.settingsManager.settings.blocksCollapsed,this.container=this.createBacklinksContainer(),this.logger.info("Appending backlinks container to the view"),this.currentTheme=this.settingsManager.settings.theme,this.applyTheme(this.currentTheme);let o=this.view.containerEl.querySelector(".markdown-preview-view")||this.view.contentEl;o?(o.classList.add("markdown-content"),o.appendChild(this.container)):this.logger.warn("Markdown content area not found.")}createBacklinksContainer(){let e=document.createElement("div");return e.classList.add("custom-backlinks-container"),e}async getBlockData(e,t){let n=[];try{let a=this.view.app.vault.getAbstractFileByPath(e);if(a&&a instanceof J.TFile){let o=await this.view.app.vault.read(a),s=this.blockBoundaryStrategy.findBlockBoundaries(o,t);for(let{start:i,end:r}of s){let p=o.substring(i,r),m=new P(p,e,t,this.settingsManager.settings.showFullPathTitle);n.push(m)}}}catch(a){console.error(`Error reading file content for ${e}:`,a)}return n}updateBlockBoundaryStrategy(e){switch(e){case"single-line":this.blockBoundaryStrategy=new C;break;case"default":default:this.blockBoundaryStrategy=new f;break}}applyTheme(e){["default","minimal","modern"].forEach(n=>{this.container.classList.remove(`theme-${n}`)}),this.container.classList.add(`theme-${e}`)}async handleThemeChange(e){this.currentTheme=e,this.settingsManager.settings.theme=e,await this.settingsManager.saveSettings(),this.applyTheme(e)}async updateBlockTitles(e){this.allBlocks.forEach(({block:t})=>{t.updateTitleDisplay(e)})}async updateBacklinks(e,t){this.logger.info("Updating backlinks:",e),this.container.empty();let n=this.container.createDiv("backlinks-list");this.logger.info("Links container:",n),this.allBlocks=[];for(let s of e)(await this.getBlockData(s,this.currentNoteName)).forEach(r=>{this.allBlocks.push({block:r,sourcePath:s})});this.allBlocks.sort((s,i)=>this.sortDescending?i.sourcePath.localeCompare(s.sourcePath):s.sourcePath.localeCompare(i.sourcePath));for(let{block:s}of this.allBlocks){await s.render(n,this.view,t);let r=s.getContainer().querySelector(".content-preview");r&&(r.style.display=this.blocksCollapsed?"none":"block"),s.setArrowState(!this.blocksCollapsed)}let a=()=>this.headerComponent.createHeader(this.container,e.length,this.allBlocks.length,this.sortDescending,()=>{this.toggleSort(),this.updateBacklinks(e,t)},()=>{this.toggleAllBlocks();let s=this.container.querySelector(".backlinks-header");if(s&&this.container.contains(s)){let i=a();this.container.replaceChild(i,s)}},this.blocksCollapsed,this.settingsManager.settings.blockBoundaryStrategy,async s=>{this.settingsManager.settings.blockBoundaryStrategy=s,await this.settingsManager.saveSettings(),this.updateBlockBoundaryStrategy(s),await this.updateBacklinks(e,t)},this.currentTheme,async s=>{await this.handleThemeChange(s)},this.settingsManager.settings.showFullPathTitle,async s=>{this.settingsManager.settings.showFullPathTitle=s,await this.settingsManager.saveSettings(),await this.updateBlockTitles(s)}),o=a();this.container.appendChild(o),this.container.appendChild(n)}toggleSort(){this.sortDescending=!this.sortDescending,this.settingsManager.settings.sortDescending=this.sortDescending,this.settingsManager.saveSettings()}toggleAllBlocks(){this.blocksCollapsed=!this.blocksCollapsed,this.settingsManager.settings.blocksCollapsed=this.blocksCollapsed,this.settingsManager.saveSettings(),this.allBlocks.forEach(({block:e})=>{let n=e.getContainer().querySelector(".content-preview");n&&(n.style.display=this.blocksCollapsed?"none":"block"),e.setArrowState(!this.blocksCollapsed)})}clear(){this.container.parentElement&&this.container.parentElement.removeChild(this.container),this.logger.info("Backlinks view cleared")}};var H=class{constructor(e,t){this.app=e;this.settingsManager=t;this.coalesceView=null;this.logger=new h}handleFileOpen(e){if(!e)return;let t=this.app.workspace.getActiveViewOfType(K.MarkdownView);if(!t)return;this.coalesceView&&this.coalesceView.clear();let n=e.basename,a=this.getStrategyFromSettings();this.coalesceView=new N(t,n,this.settingsManager,a);let o=this.app.metadataCache.resolvedLinks,s=Object.entries(o).filter(([i,r])=>e.path in r).map(([i])=>i);this.coalesceView.updateBacklinks(s,i=>{this.app.workspace.openLinkText(i,"",!1)})}getStrategyFromSettings(){switch(this.settingsManager.settings.blockBoundaryStrategy){case"single-line":return new C;case"default":default:return new f}}clearBacklinks(){this.coalesceView&&this.coalesceView.clear()}};var A=require("obsidian"),F=class extends A.PluginSettingTab{constructor(t,n,a){super(t,n);this.plugin=n;this.settingsManager=a}display(){let{containerEl:t}=this;t.empty(),new A.Setting(t).setName("Show in Daily Notes").setDesc("Enable Coalesce view in daily notes").addToggle(n=>n.setValue(this.settingsManager.settings.showInDailyNotes).onChange(async a=>{this.settingsManager.settings.showInDailyNotes=a,await this.settingsManager.saveSettings()}))}};var $=class extends Q.Plugin{async onload(){this.logger=new h,this.settingsManager=new x(this),await this.settingsManager.loadSettings(),this.addSettingTab(new F(this.app,this,this.settingsManager)),this.coalesceManager=new H(this.app,this.settingsManager),this.app.workspace.on("file-open",t=>{if(!t)return;let n=this.isDailyNote(t);!n||n&&this.settingsManager.settings.showInDailyNotes?this.coalesceManager.handleFileOpen(t):this.coalesceManager.clearBacklinks()}),window.enableLogging=function(){h.enable(),console.log("Logging enabled")},window.disableLogging=function(){h.disable(),console.log("Logging disabled")}}onunload(){this.coalesceManager.clearBacklinks()}isDailyNote(t){let n=this.app.internalPlugins.plugins["daily-notes"];if(!n||!n.enabled)return this.logger.debug("Daily Notes plugin is not enabled."),!1;let a=n.instance.options.folder||"";a||this.logger.debug("Daily Notes folder not set, using vault root.");let o=/^\d{4}-\d{2}-\d{2}\.md$/;return t.path.startsWith(a)?o.test(t.name):!1}};
